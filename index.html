<!doctype html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Format & Date Log App — Updated</title>
<style>
  /* ============ THEMES (eye comfort palettes) ============= */
  :root{
    --bg:#f7f9fb; --card:#ffffff; --muted:#374151; --accent:#2563eb; --muted-2:#6b7280; --glass:rgba(0,0,0,0.04);
    --accent-2:#f59e0b;
  }
  .theme-dark{
    --bg:#0f1724; --card:#0b1220; --muted:#dbeafe; --muted-2:#94a3b8; --accent:#60a5fa; --glass:rgba(255,255,255,0.03); --accent-2:#fbbf24;
  }
  .theme-light{
    --bg:#f6f8fb; --card:#ffffff; --muted:#0f1724; --muted-2:#475569; --accent:#2563eb; --glass:rgba(2,6,23,0.03); --accent-2:#b45309;
  }
  /* Eye-comfort palettes (warmer, lower blue) */
  .theme-eye-light{
    --bg:#fbf7ef; --card:#fffaf2; --muted:#2b2b24; --muted-2:#6b5f52; --accent:#d97706; --glass:rgba(0,0,0,0.03); --accent-2:#b45309;
  }
  .theme-eye-dark{
    --bg:#12100c; --card:#161412; --muted:#f7efe3; --muted-2:#bfae9a; --accent:#fbbf24; --glass:rgba(255,255,255,0.02); --accent-2:#f59e0b;
  }html,body{height:100%;margin:0;font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial; background:var(--bg); color:var(--muted);} header{display:flex;align-items:center;gap:12px;padding:12px;box-shadow:0 1px 0 var(--glass);position:sticky;top:0;background:var(--bg);z-index:20} h1{margin:0;font-size:16px} nav{margin-left:auto;display:flex;gap:6px;flex-wrap:wrap} button, input[type=file]{font:inherit} .nav-btn{background:transparent;border:1px solid var(--glass);padding:8px 10px;border-radius:8px;color:var(--muted-2);cursor:pointer} .nav-btn.active{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#04203a;border:none} .container{display:grid;grid-template-columns:1fr;gap:12px;padding:12px;max-width:980px;margin:0 auto} .card{background:var(--card);padding:12px;border-radius:12px;border:1px solid var(--glass);box-shadow:0 6px 18px rgba(2,6,23,0.02)} .row{display:flex;gap:8px;align-items:center} .small{font-size:13px;color:var(--muted-2)} input[type=text],input[type=date],textarea,select{width:100%;padding:8px;border-radius:8px;border:1px solid var(--glass);background:transparent;color:var(--muted);box-sizing:border-box} textarea{min-height:64px;resize:vertical} .action{background:linear-gradient(90deg,var(--accent),var(--accent-2));border:none;color:#04203a;padding:8px 10px;border-radius:8px;cursor:pointer} .danger{background:transparent;border:1px solid #ef4444;color:#ef4444;padding:8px 10px;border-radius:8px;cursor:pointer} .muted{color:var(--muted-2)} .controls{display:flex;gap:8px;flex-wrap:wrap} .cards{display:flex;flex-direction:column;gap:10px;margin-top:10px} .card-field{border:1px dashed var(--glass);padding:10px;border-radius:10px;background:linear-gradient(180deg,rgba(0,0,0,0.02),transparent);display:flex;gap:10px;align-items:flex-start} .card-handle{width:24px;height:24px;background:var(--glass);border-radius:6px;display:flex;align-items:center;justify-content:center;cursor:grab} .card-handle:active{cursor:grabbing} .card-content{flex:1} .card-meta{display:flex;gap:6px;align-items:center;margin-left:auto} .small-muted{font-size:12px;color:var(--muted-2)} .pill{padding:6px 8px;border-radius:999px;border:1px solid var(--glass);font-size:13px} footer{padding:12px;text-align:center;font-size:13px;color:var(--muted-2)} @media (max-width:880px){ .row{flex-direction:column;align-items:stretch} .nav-btn{padding:8px} } </style>

</head>
<body>
<header>
  <h1>Format & Date-based Log</h1>
  <nav>
    <button id="navFormat" class="nav-btn active">Format</button>
    <button id="navUse" class="nav-btn">Use</button>
    <button id="navSettings" class="nav-btn">Settings</button>
  </nav>
</header><div class="container">  <!-- FORMAT PAGE -->  <section id="pageFormat" class="card" aria-hidden="false">
    <div style="display:flex;align-items:center;gap:8px">
      <strong>Format Editor</strong>
      <div class="small-muted">Drag to reorder. Changes saved automatically.</div>
      <div style="margin-left:auto" class="small muted">Theme:
        <select id="miniTheme" style="margin-left:8px;padding:6px;border-radius:8px;border:1px solid var(--glass);background:transparent;color:var(--muted)">
          <option value="auto">Auto (device)</option>
          <option value="light">Light</option>
          <option value="dark">Dark</option>
          <option value="light-eye">Light (eye comfort)</option>
          <option value="dark-eye">Dark (eye comfort)</option>
        </select>
      </div>
    </div><div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
  <button id="addFieldBtn" class="action">Add Field</button>
  <button id="loadExampleBtn" class="action">Load Example Schedule</button>
  <button id="clearFormatBtn" class="danger">Clear Format</button>
  <div style="margin-left:auto" class="small-muted">Storage auto-saves to device.</div>
</div>

<div id="formatCards" class="cards" style="margin-top:12px"></div>

<hr style="border:none;height:1px;background:var(--glass);margin-top:12px"/>

<div style="display:flex;gap:8px;flex-wrap:wrap">
  <button id="exportFormatBtn" class="action">Export Format</button>
  <button id="importFormatBtn" class="action">Import Format</button>
  <input id="importFormatFile" type="file" accept="application/json" style="display:none">
  <button id="saveFormatBtn" class="pill">Save (manual)</button>
</div>

  </section>  <!-- USE PAGE -->  <section id="pageUse" class="card" style="display:none">
    <div style="display:flex;gap:8px;align-items:center;">
      <strong>Use Mode — Date-based logs</strong>
      <div style="margin-left:auto" class="small-muted">Select date to load/save entries</div>
    </div><div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap;align-items:center">
  <label class="small-muted">Select date</label>
  <input id="useDate" type="date" style="width:180px"/>
  <button id="newEntryBtn" class="action">New / Clear Day</button>
  <div style="margin-left:auto" class="small-muted">Autosaves as you type</div>
</div>

<div id="useCards" class="cards" style="margin-top:12px"></div>

<div style="margin-top:8px" class="small-muted">Tip: switch to Format to change structure. Deleting a date from Settings removes saved values for that date.</div>

  </section>  <!-- SETTINGS PAGE -->  <section id="pageSettings" class="card" style="display:none">
    <div style="display:flex;gap:8px;align-items:center;">
      <strong>Settings & Backup</strong>
      <div style="margin-left:auto" class="small-muted">Manage backups and per-date deletion</div>
    </div><div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
  <button id="exportAllBtn" class="action">Backup All (format + logs)</button>
  <button id="exportFormatOnlyBtn" class="action">Export Format Only</button>
  <button id="exportLogsOnlyBtn" class="action">Export Logs Only</button>
  <button id="importAllBtn" class="action">Restore Backup</button>
  <input id="importAllFile" type="file" accept="application/json" style="display:none">

  <button id="importFormatOnlyBtn" class="action">Import Format File</button>
  <input id="importFormatOnlyFile" type="file" accept="application/json" style="display:none">

  <button id="importLogsOnlyBtn" class="action">Import Logs File</button>
  <input id="importLogsOnlyFile" type="file" accept="application/json" style="display:none">

  <button id="exportDayBtn" class="action">Export This Date</button>
  <input id="exportDayDate" type="date" style="width:170px"/>

  <button id="importDayBtn" class="action">Import Day Data</button>
  <input id="importDayFile" type="file" accept="application/json" style="display:none">

  <button id="clearAllBtn" class="danger">Reset App (clear everything)</button>
</div>

<hr style="border:none;height:1px;background:var(--glass);margin-top:12px"/>

<div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap">
  <div>
    <div class="small-muted">Delete specific date</div>
    <input id="deleteDate" type="date" style="margin-top:6px"/>
    <button id="deleteDateBtn" class="danger" style="margin-left:6px">Delete</button>
  </div>

  <div style="margin-left:auto" class="small-muted">
    <div>App version: <strong>1.1</strong></div>
    <div id="infoCounts"></div>
  </div>
</div>

  </section></div><footer>
  <div class="small muted">PWA install supported. Data stored locally. No alarms included.</div>
</footer><script>
/* ================== STORAGE KEYS ================== */
const KEY_FMT = 'fmt_v1';
const KEY_LOGS = 'logs_v1'; // logs stored as object { "YYYY-MM-DD": { values: { fieldId: value, ... } } }

/* ================== APP STATE ================== */
let format = loadJSON(KEY_FMT) || []; // array of { id, label, type }
let logs = loadJSON(KEY_LOGS) || {};  // object mapping date -> { values: {fieldId: value} }

/* ============== THEME ============== */
const themeSelect = document.getElementById('miniTheme');
const savedTheme = localStorage.getItem('theme_pref') || 'auto';
themeSelect.value = savedTheme;
applyTheme(savedTheme);
themeSelect.addEventListener('change', e => { const v = e.target.value; localStorage.setItem('theme_pref', v); applyTheme(v); });

function applyTheme(pref){
  // clear all theme classes
  document.documentElement.classList.remove('theme-dark','theme-light','theme-eye-light','theme-eye-dark');
  if(pref === 'dark'){ document.documentElement.classList.add('theme-dark'); }
  else if(pref === 'light'){ document.documentElement.classList.add('theme-light'); }
  else if(pref === 'light-eye'){ document.documentElement.classList.add('theme-eye-light'); }
  else if(pref === 'dark-eye'){ document.documentElement.classList.add('theme-eye-dark'); }
  else { // auto
    const mq = window.matchMedia('(prefers-color-scheme: dark)');
    if(mq.matches) document.documentElement.classList.add('theme-dark'); else document.documentElement.classList.add('theme-light');
  }
}

/* ============== NAV ============== */
const navFormat = document.getElementById('navFormat');
const navUse = document.getElementById('navUse');
const navSettings = document.getElementById('navSettings');
const pageFormat = document.getElementById('pageFormat');
const pageUse = document.getElementById('pageUse');
const pageSettings = document.getElementById('pageSettings');
navFormat.onclick = ()=> showPage('format');
navUse.onclick = ()=> showPage('use');
navSettings.onclick = ()=> showPage('settings');
function showPage(p){
  pageFormat.style.display = p==='format'? 'block':'none';
  pageUse.style.display = p==='use'? 'block':'none';
  pageSettings.style.display = p==='settings'? 'block':'none';
  navFormat.classList.toggle('active', p==='format');
  navUse.classList.toggle('active', p==='use');
  navSettings.classList.toggle('active', p==='settings');
  if(p==='format') renderFormatCards();
  if(p==='use') renderUseCards();
  if(p==='settings') updateInfoCounts();
}

/* ============== UTIL ============== */
function saveJSON(key, obj){ localStorage.setItem(key, JSON.stringify(obj)); }
function loadJSON(key){ try{ const s = localStorage.getItem(key); return s ? JSON.parse(s) : null; } catch(e){ return null; } }
function uid(prefix='f'){ return prefix + Math.random().toString(36).slice(2,9); }
function todayISO(){ const d = new Date(); const mm = String(d.getMonth()+1).padStart(2,'0'); const dd = String(d.getDate()).padStart(2,'0'); return `${d.getFullYear()}-${mm}-${dd}`; }

/* Strong confirmation for destructive actions — reduces accidental clears */
function confirmStrong(actionDescription){
  const v = prompt(`${actionDescription}\nType DELETE to confirm:`);
  return v === 'DELETE';
}

/* ============== FORMAT (cards with drag) ============== */
const formatCards = document.getElementById('formatCards');
const addFieldBtn = document.getElementById('addFieldBtn');
const loadExampleBtn = document.getElementById('loadExampleBtn');
const clearFormatBtn = document.getElementById('clearFormatBtn');
const exportFormatBtn = document.getElementById('exportFormatBtn');
const importFormatBtn = document.getElementById('importFormatBtn');
const importFormatFile = document.getElementById('importFormatFile');
const saveFormatBtn = document.getElementById('saveFormatBtn');

addFieldBtn.onclick = ()=> {
  const label = prompt('Field label (e.g., "4:15 AM", "Notes", "Task")','New field');
  if(!label) return;
  const type = prompt('Type: short / long / checkbox / bullets / time','short');
  if(!['short','long','checkbox','bullets','time'].includes(type)){ alert('Invalid type'); return; }
  format.push({ id: uid('f'), label, type });
  persistFormat();
  renderFormatCards();
};
loadExampleBtn.onclick = ()=> {
  if(!confirm('Replace existing format with example schedule?')) return;
  const times = ["4:15 AM","4:30 AM","5:00 AM","5:30 AM","6:00 AM","7:00 AM","8:00 AM","9:00 AM","10:00 AM","11:00 AM","12:00 PM","1:00 PM","5:00 PM","6:00 PM","7:00 PM","8:00 PM","9:00 PM","10:00 PM"];
  format = [{ id: uid('f'), label: 'Date', type:'short' }];
  for(const t of times) format.push({ id: uid('f'), label: t, type:'long' });
  persistFormat();
  renderFormatCards();
};

clearFormatBtn.onclick = ()=> { 
  if(!confirmStrong('Clear format? This WILL NOT delete saved logs.')) return;
  format = []; persistFormat(); renderFormatCards(); 
};

exportFormatBtn.onclick = ()=> downloadFile(format, 'format.json');
importFormatBtn.onclick = ()=> importFormatFile.click();
importFormatFile.onchange = (e)=> {
  const f = e.target.files[0]; if(!f) return;
  const r = new FileReader(); r.onload = ev => {
    try{ const obj = JSON.parse(ev.target.result); if(!Array.isArray(obj)) throw new Error('Format JSON must be array'); format = obj; persistFormat(); renderFormatCards(); alert('Format imported'); } catch(err){ alert('Import failed: ' + err.message); }
  }; r.readAsText(f); importFormatFile.value='';
};
saveFormatBtn.onclick = ()=> { persistFormat(); alert('Format saved'); };

function persistFormat(){ saveJSON(KEY_FMT, format); updateInfoCounts(); }
function persistLogs(){ saveJSON(KEY_LOGS, logs); updateInfoCounts(); }

function renderFormatCards(){
  formatCards.innerHTML = '';
  if(format.length===0){ formatCards.innerHTML = `<div class="small-muted">No fields yet. Add fields to start.</div>`; return; }
  format.forEach((f, idx) => {
    const el = document.createElement('div'); el.className = 'card-field'; el.draggable = true; el.dataset.id = f.id;
    // drag handle
    const handle = document.createElement('div'); handle.className='card-handle'; handle.title='Drag to reorder'; handle.innerHTML='☰';
    el.appendChild(handle);
    // content
    const content = document.createElement('div'); content.className='card-content';
    const label = document.createElement('div'); label.innerHTML = `<strong>${escapeHtml(f.label)}</strong> <div class="small-muted" style="font-size:12px">${f.type}</div>`;
    content.appendChild(label);
    // edit controls
    const controls = document.createElement('div'); controls.style.display='flex'; controls.style.gap='6px'; controls.style.marginTop='8px';
    const editBtn = document.createElement('button'); editBtn.className='pill'; editBtn.textContent='Edit';
    editBtn.onclick = ()=> {
      const newLabel = prompt('Label', f.label) || f.label;
      const newType = prompt('Type (short,long,checkbox,bullets,time)', f.type) || f.type;
      if(!['short','long','checkbox','bullets','time'].includes(newType)){ alert('Invalid type'); return; }
      f.label = newLabel; f.type = newType;
      persistFormat(); renderFormatCards();
    };
    const delBtn = document.createElement('button'); delBtn.className='danger'; delBtn.textContent='Delete';
    delBtn.onclick = ()=> { 
      if(!confirmStrong('Delete this field? All saved logs keep their values but the field will be removed from the format.')) return;
      format = format.filter(x=>x.id !== f.id); persistFormat(); renderFormatCards(); 
    };
    controls.append(editBtn, delBtn);
    content.appendChild(controls);
    el.appendChild(content);
    // drag events
    el.addEventListener('dragstart', dragStart);
    el.addEventListener('dragover', dragOver);
    el.addEventListener('drop', dragDrop);
    el.addEventListener('dragend', dragEnd);
    formatCards.appendChild(el);
  });
}

/* Drag & drop implementation (simple) */
let dragSrc = null;
function dragStart(e){ dragSrc = this; e.dataTransfer.effectAllowed = 'move'; this.style.opacity = '0.6'; }
function dragOver(e){ e.preventDefault(); e.dataTransfer.dropEffect = 'move'; }
function dragDrop(e){
  e.stopPropagation();
  if(dragSrc !== this){
    // swap positions in DOM and in format array
    const srcId = dragSrc.dataset.id, dstId = this.dataset.id;
    const i = format.findIndex(x=>x.id===srcId), j = format.findIndex(x=>x.id===dstId);
    if(i>=0 && j>=0){
      const [it] = format.splice(i,1);
      format.splice(j,0,it);
      persistFormat();
      renderFormatCards();
    }
  }
}
function dragEnd(e){ this.style.opacity = ''; dragSrc = null; }

/* ============== USE PAGE (date-based) ============== */
const useDate = document.getElementById('useDate');
const useCards = document.getElementById('useCards');
const newEntryBtn = document.getElementById('newEntryBtn');

// default to today
useDate.value = todayISO();
useDate.addEventListener('change', ()=> renderUseCards()); // load selected date

newEntryBtn.onclick = ()=> {
  if(!confirmStrong('Clear values for this date? This will overwrite current date values with empty defaults.')) return;
  const d = useDate.value || todayISO();
  logs[d] = { values: {} };
  // initialize with empty values
  for(const f of format) logs[d].values[f.id] = (f.type==='checkbox'? false : '');
  persistLogs();
  renderUseCards();
};

function renderUseCards(){
  useCards.innerHTML = '';
  const d = useDate.value || todayISO();
  if(!(d in logs)) logs[d] = { values: {} }; // ensure object exists
  const dayObj = logs[d];
  // ensure all fields have keys
  for(const f of format) if(!(f.id in dayObj.values)) dayObj.values[f.id] = (f.type==='checkbox'? false : '');
  persistLogs();

  if(format.length===0){
    useCards.innerHTML = '<div class="small-muted">No format defined. Add fields in Format page first.</div>';
    return;
  }

  format.forEach(f => {
    const el = document.createElement('div'); el.className='card-field';
    // no drag here - this is use mode
    const handle = document.createElement('div'); handle.className='card-handle'; handle.innerHTML='●'; handle.title='Field';
    el.appendChild(handle);

    const content = document.createElement('div'); content.className='card-content';
    const label = document.createElement('div'); label.innerHTML = `<strong>${escapeHtml(f.label)}</strong> <div class="small-muted" style="font-size:12px">${f.type}</div>`;
    content.appendChild(label);

    // value input depending on type
    if(f.type === 'short' || f.type === 'time'){
      const inp = document.createElement('input'); inp.type='text';
      inp.value = dayObj.values[f.id] ?? '';
      inp.oninput = ()=> { dayObj.values[f.id] = inp.value; persistLogs(); };
      content.appendChild(inp);

    } else if(f.type === 'long'){
      const ta = document.createElement('textarea');
      ta.value = dayObj.values[f.id] ?? '';
      ta.oninput = ()=> { dayObj.values[f.id] = ta.value; persistLogs(); };
      content.appendChild(ta);

    } else if(f.type === 'checkbox'){
      const row = document.createElement('div'); row.style.display='flex'; row.style.alignItems='center'; row.style.gap='8px';
      const cb = document.createElement('input'); cb.type='checkbox';
      cb.checked = !!dayObj.values[f.id];
      cb.onchange = ()=> { dayObj.values[f.id] = cb.checked; persistLogs(); };
      row.appendChild(cb);
      const lab = document.createElement('div'); lab.textContent = 'Checked';
      row.appendChild(lab);
      content.appendChild(row);

    } else if(f.type === 'bullets'){
      const ta = document.createElement('textarea');
      ta.value = (Array.isArray(dayObj.values[f.id]) ? dayObj.values[f.id].join('\n') : (dayObj.values[f.id] || ''));
      ta.oninput = ()=> { dayObj.values[f.id] = ta.value.split(/\r?\n/).map(s=>s.trim()).filter(Boolean); persistLogs(); };
      content.appendChild(ta);
    }

    // small actions: clear value for this field on this date
    const meta = document.createElement('div'); meta.className='card-meta';
    const clearBtn = document.createElement('button'); clearBtn.className='pill'; clearBtn.textContent='Clear';
    clearBtn.onclick = ()=> { if(!confirmStrong('Clear this field for selected date?')) return; dayObj.values[f.id] = (f.type==='checkbox'? false : ''); persistLogs(); renderUseCards(); };
    meta.appendChild(clearBtn);

    content.appendChild(meta);
    el.appendChild(content);
    useCards.appendChild(el);
  });
}

/* ============== SETTINGS ============== */
const exportAllBtn = document.getElementById('exportAllBtn');
const exportFormatOnlyBtn = document.getElementById('exportFormatOnlyBtn');
const exportLogsOnlyBtn = document.getElementById('exportLogsOnlyBtn');
const importAllBtn = document.getElementById('importAllBtn');
const importAllFile = document.getElementById('importAllFile');
const importFormatOnlyBtn = document.getElementById('importFormatOnlyBtn');
const importFormatOnlyFile = document.getElementById('importFormatOnlyFile');
const importLogsOnlyBtn = document.getElementById('importLogsOnlyBtn');
const importLogsOnlyFile = document.getElementById('importLogsOnlyFile');
const exportDayBtn = document.getElementById('exportDayBtn');
const exportDayDate = document.getElementById('exportDayDate');
const importDayBtn = document.getElementById('importDayBtn');
const importDayFile = document.getElementById('importDayFile');
const clearAllBtn = document.getElementById('clearAllBtn');
const deleteDate = document.getElementById('deleteDate');
const deleteDateBtn = document.getElementById('deleteDateBtn');
const infoCounts = document.getElementById('infoCounts');

exportAllBtn.onclick = ()=> {
  try{
    const all = { format, logs, version: '1.1', exportedAt: (new Date()).toISOString() };
    downloadFile(all, 'backup_format_logs.json');
  }catch(err){ alert('Export failed: ' + err.message); }
};

exportFormatOnlyBtn.onclick = ()=> downloadFile(format, 'format_only.json');
exportLogsOnlyBtn.onclick = ()=> downloadFile(logs, `logs_only_${todayISO()}.json`);

importAllBtn.onclick = ()=> importAllFile.click();
importAllFile.onchange = e => {
  const f = e.target.files[0]; if(!f) return;
  const r = new FileReader(); r.onload = ev => {
    try{
      const obj = JSON.parse(ev.target.result);
      if(obj.format && obj.logs){
        if(!confirmStrong('Restore backup: this will replace current format and logs.')) return;
        format = obj.format; logs = obj.logs; persistFormat(); persistLogs(); alert('Backup restored'); renderFormatCards(); updateInfoCounts();
      } else alert('Invalid backup file');
    }catch(err){ alert('Import failed: ' + err.message); }
  }; r.readAsText(f); importAllFile.value='';
};

importFormatOnlyBtn.onclick = ()=> importFormatOnlyFile.click();
importFormatOnlyFile.onchange = e => {
  const f = e.target.files[0]; if(!f) return;
  const r = new FileReader(); r.onload = ev => {
    try{ const obj = JSON.parse(ev.target.result); if(!Array.isArray(obj)) throw new Error('Format JSON must be array'); format = obj; persistFormat(); renderFormatCards(); alert('Format imported'); } catch(err){ alert('Import failed: ' + err.message); }
  }; r.readAsText(f); importFormatOnlyFile.value='';
};

importLogsOnlyBtn.onclick = ()=> importLogsOnlyFile.click();
importLogsOnlyFile.onchange = e => {
  const f = e.target.files[0]; if(!f) return;
  const r = new FileReader(); r.onload = ev => {
    try{ const obj = JSON.parse(ev.target.result); if(typeof obj !== 'object') throw new Error('Logs JSON must be an object'); logs = obj; persistLogs(); alert('Logs imported'); } catch(err){ alert('Import failed: ' + err.message); }
  }; r.readAsText(f); importLogsOnlyFile.value='';
};

exportDayBtn.onclick = ()=> {
  const d = exportDayDate.value || todayISO();
  if(!(d in logs)){ return alert('No data for this date'); }
  downloadFile(logs[d], `logs_${d}.json`);
};
importDayBtn.onclick = ()=> importDayFile.click();
importDayFile.onchange = e => {
  const f = e.target.files[0]; if(!f) return;
  const r = new FileReader(); r.onload = ev => {
    try{
      const obj = JSON.parse(ev.target.result);
      // expected shape: { values: {...} }
      const d = exportDayDate.value || todayISO();
      if(obj.values){ if(!confirmStrong(`Import day data into ${d}? This will overwrite existing values for that date.`)) return; logs[d] = obj; persistLogs(); alert('Day data imported'); } 
      else alert('Invalid day file');
    } catch(err){ alert('Import failed: ' + err.message); }
  }; r.readAsText(f); importDayFile.value='';
};

clearAllBtn.onclick = ()=> {
  if(!confirmStrong('Reset app: clear format and all logs? This cannot be undone.')) return;
  format = []; logs = {}; localStorage.removeItem(KEY_FMT); localStorage.removeItem(KEY_LOGS); updateInfoCounts(); renderFormatCards(); renderUseCards();
  alert('App reset completed.');
};

deleteDateBtn.onclick = ()=> {
  const d = deleteDate.value || '';
  if(!d) return alert('Select a date to delete');
  if(!(d in logs)) return alert('No data stored for that date');
  if(!confirmStrong(`Delete saved data for ${d}? This cannot be undone.`)) return;
  delete logs[d]; persistLogs(); updateInfoCounts(); renderUseCards(); alert('Deleted ' + d);
};

function updateInfoCounts(){
  const logCount = Object.keys(logs).length;
  infoCounts.innerHTML = `Fields: <strong>${format.length}</strong> &nbsp;|&nbsp; Saved Dates: <strong>${logCount}</strong>`;
  // set defaults for export date inputs
  exportDayDate.value = useDate.value || todayISO();
  deleteDate.value = useDate.value || todayISO();
}

/* ============== BOOT ============== */
function init(){
  // ensure some structure
  if(!Array.isArray(format)) format = [];
  if(typeof logs !== 'object' || logs === null) logs = {};
  renderFormatCards();
  renderUseCards();
  updateInfoCounts();
  showPage('format');
}
init();

/* ============== HELPERS ============== */
function downloadFile(obj, filename){
  try{
    const blob = new Blob([JSON.stringify(obj, null, 2)], { type:'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = filename; document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
  }catch(err){ alert('Download failed: ' + err.message); }
}
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

/* ============== PERSIST LOAD/INIT ============== */
function loadFromLocal(){
  const f = loadJSON(KEY_FMT); if(f) format = f;
  const l = loadJSON(KEY_LOGS); if(l) logs = l;
}
loadFromLocal(); // initial load

// update whenever page unloads (safety)
window.addEventListener('beforeunload', ()=> { saveJSON(KEY_FMT, format); saveJSON(KEY_LOGS, logs); });

// expose some debug helpers to console
window._app = { format, logs, save: ()=> { saveJSON(KEY_FMT, format); saveJSON(KEY_LOGS, logs); } };

</script>
</body>
</html>
